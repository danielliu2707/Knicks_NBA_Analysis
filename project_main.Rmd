---
title: "Exploring The Failures of The New York Knicks"
author: "Daniel Liu"
date: "27/06/2023"
output: 
  html_document: 
    fig_caption: yes
---

```{r setup, warning=FALSE, error=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stopwords)
library(tidyverse)
library(tidytext)
library(textdata)
library(lubridate)
library(plotly)
library(cowplot)
library(polite)
library(rvest)
library(janitor)
library(data.table)
library(rstatix)
```

# Analysis using nba_api dataframes:


Look at the correlation between different things. Maybe using those that most correlate, try
to use a Linear Model to predict a teams success. Try to predict the Knicks future success?

Use all_team_stats instead of all the previous dfs. Better now. Shows wins/losses much easier!!!

Use team_metrics as interesting statistics to look at and see their importance.



# Extracting data using nba_api in Python:

```{python echo = F, eval = F}
import pandas as pd
import requests
import numpy as np
from nba_api.stats.endpoints import leaguegamefinder
from nba_api.stats.endpoints import teamyearbyyearstats
from nba_api.stats.endpoints import franchiseplayers
from nba_api.stats.endpoints import teamestimatedmetrics
from nba_api.stats.static import teams
from nba_api.stats.static import players
```

```{python}
# Helps identify the different teams and their IDs
all_teams = teams.get_teams()
team_mappings = {}
for team in all_teams:
    team_mappings[team['abbreviation']] = team['id']
    
team_ids = []
for team in all_teams:
    team_ids.append(team['id'])

team_abbrevs = []
for team in all_teams:
    team_abbrevs.append(team['abbreviation'])
team_mappings
```

```{python eval = F}
# Obtaining advanced metrics for all teams 2013 onwards:
seasons = ['2013-14', '2014-15', '2015-16', '2016-17', '2017-18', '2018-19', '2019-20', '2020-21', '2021-22', '2022-23']
team_metrics = []
for season in seasons:
    tmp = teamestimatedmetrics.TeamEstimatedMetrics(season = season).get_data_frames()[0]
    tmp["YEAR"] = season[:4]
    team_metrics.append(tmp)
team_metrics = pd.concat(team_metrics, ignore_index = True)
team_metrics.to_csv("team_metrics.csv", index = False)
```

```{python eval = F}
# Gets stats for a single team
def get_team_stats(individual_team_id: int):
    all_df = teamyearbyyearstats.TeamYearByYearStats(team_id = individual_team_id, timeout = 10).get_data_frames()[0]
    all_df = all_df.tail(10)
    all_df["YEAR"] = all_df["YEAR"].apply(lambda year: year[:4])
    return all_df
```

```{python eval = F}
# Obtaining basic team stats from 2013 on wards:
team_data = []
for team_id in team_ids:
    team_info = get_team_stats(str(team_id))
    team_data.append(team_info)
all_team_df = pd.concat(team_data, ignore_index = True)
all_team_df.to_csv("all_team_stats.csv", index = True)
```

```{python eval = F}
# Obtaining NYK team stats from 2013 on wards:
NYK_stats_df = teamyearbyyearstats.TeamYearByYearStats(team_id = 1610612752, timeout = 10).get_data_frames()[0].tail(10)
NYK_stats_df["YEAR"] = NYK_stats_df["YEAR"].apply(lambda year: year[:4])
NYK_stats_df.to_csv("nyk_team_stats.csv", index = True)
```












# Introduction

As a "junior data analyst" working in the basketball analytics team for Hudl, a sports analytics company specializing in improving team performance, I am tasked with gaining insight into why the New York Knicks have disappointed over the past decade in the NBA. The insights I uncover will then be presented to a New York Knicks representative to help uncover key areas of improvement to hopefully win more games. I will approach this task through the [https://www.geeksforgeeks.org/six-steps-of-data-analysis-process/](Six Steps of Data Analysis Process).

# Ask

In this stage, I consider questions that might offer insights into the Knicks failures from 2013-2022.

### Questions of Interest
1. How has the rise in popularity of the 3 point shot impacted the Knicks?
2. Does the team salary play a role in the success of a team?
3. What players should the Knicks focus on drafting for greater success?

# Prepare 

I used two datasets. Firstly, [https://www.kaggle.com/datasets/wyattowalsh/basketball](NBA Database) is a dataset containing statistics on all 30 NBA teams, 4800+ NBA players and 60,000+ NBA games throughout history. Secondly, [https://www.kaggle.com/datasets/jarosawjaworski/current-nba-players-contracts-history](NBA Salaries) is a dataset containing NBA player salaries between 2010-2020.

Through exploring and understand each dataset, I identified 7 datasets from the NBA Database that are suitable for the purposes of this analysis. Furthermore, the salaries dataset only goes up to 2020, whereas this analysis goes up till 2022. To resolve this lack of data, I scraped data from [https://www.spotrac.com/nba/cap/2022/](spotrac) to obtain NBA team salaries between 2021-2022.  

***

Importing required files

```{r results='hide'}
draft_history_df <- read_csv(here::here("nba_data", "draft_history.csv"))
game_info_df <- read_csv(here::here("nba_data", "game_info.csv"))
game_df <- read_csv(here::here("nba_data", "game.csv"))
common_player_info_df <- read_csv(here::here("nba_data", "common_player_info.csv"))
team_df <- read_csv(here::here("nba_data", "team.csv"))
glimpse(team_df)
player_info <- read_csv(here::here("nba_data", "all_seasons.csv"))
salaries <- read_csv(here::here("nba_data", "nba_salaries.csv"))
play_by_play_df <- read_csv(here::here("nba_data", "play_by_play.csv"))
```

```{r}
all_team_stats <- read_csv(here::here("nba_data", "all_team_stats.csv"))
glimpse(all_team_stats)
nyk_team_stats <- read_csv(here::here("nba_data", "nyk_team_stats.csv"))
team_metrics <- read_csv(here::here("nba_data", "team_metrics.csv"))
glimpse(team_metrics)
```


# Process

I clean the column names of data frames from NBA API:
```{r}
all_team_stats <- clean_names(all_team_stats)
nyk_team_stats <- clean_names(nyk_team_stats)
team_metrics <- clean_names(team_metrics)
```


As the Charlotte Bobcats became the Hornets in 2013 (i.e. team name change), change their name in 2013 to the Hornets.
```{r}
all_team_stats <- all_team_stats %>% 
  mutate(team_name = recode(team_name, "Bobcats" = "Hornets"))

team_metrics <- team_metrics %>% 
  mutate(team_name = recode(team_name, "Charlotte Bobcats" = "Charlotte Hornets"))
```


I get combine individual player salaries into 30 NBA team salaries to keep the analysis consistent on teams throughout, rather than players.

```{r results='hide'}
salaries <- salaries %>% 
  select(team, salary, season) %>% 
  filter(season >= 2013) %>% 
  filter(!(team %in% c("Fenerbahce Ulker Fenerbahce Ulker", "Maccabi Haifa Maccabi Haifa", "null Unknown",
                       "Madrid Real Madrid", "Charlotte Bobcats", "New Orleans Hornets"))) %>% 
  group_by(team, season) %>% 
  summarize(salary = sum(salary))
```

Next, I perform web-scraping to get 2021 and 2022 NBA salary data.

```{r}
scrape_salaries <- function(html_link, year){
  page <- read_html(html_link)
  table <- page %>% 
    html_table() %>% 
    data.frame() %>% 
    as_tibble() %>% 
    select(Team, Total.Cap) %>% 
    rename("salary" = "Total.Cap",
         "team" = "Team") %>% 
    mutate(across("salary", ~gsub("\\$", "", .))) %>% 
    mutate(across("salary", ~gsub("\\,", "", .))) %>% 
    mutate(season = year)
  
  table$salary <- as.numeric(table$salary)
  
  returned_df <- salaries %>% 
    bind_rows(table)
  
  return(returned_df)
  
}

salaries <- scrape_salaries("https://www.spotrac.com/nba/cap/2022/", 2022)
salaries <- scrape_salaries("https://www.spotrac.com/nba/cap/2021/", 2021)
```

As the analysis is conducted between 2013-2022, I filter for data from 29/10/2013 (start of 2013 NBA season) till present.

```{r results='hide'}
game_df$game_date <- as.Date(game_df$game_date)
game_df$season_id <- as.character(game_df$season_id)
game_df <- game_df %>%
  filter(game_date > "2013-10-29") %>% 
  mutate(year = substring(season_id, 2))

game_info_df$game_date <- as.Date(game_info_df$game_date)
game_info_df <- game_info_df %>% 
  na.omit() %>% 
  mutate(year = year(game_date)) %>% 
    filter(game_date > "2013-10-29")

play_by_play_df <- game_df %>% 
  select(game_id, game_date) %>% 
  right_join(play_by_play_df, on = "game_id") %>% 
  filter(game_date > "2013-10-29")
```

For the analysis, I require information on each of the 30 teams wins and losses. As such data was not provided in the Kaggle dataset, I used the nba_api to extract information regarding wins and losses, among other statistics for each team.

```{r}
team_wins_df <- all_team_stats %>% 
  select(team_id, team_name, year, gp, wins, losses, win_pct) %>% 
  mutate(win_pct = win_pct * 100) %>% 
  arrange(year)

knitr::kable(head(team_wins_df, 6))
```



# Analyze: 

Please note that team abbreviations will be used in some data frames and visualizations. A list of team abbreviations and their full names can be found [https://en.wikipedia.org/wiki/Wikipedia:WikiProject_National_Basketball_Association/National_Basketball_Association_team_abbreviations](here).

***

# FROM HERE ON, I HAVEN'T STARTED FINALIZING THE REPORT.

It's not secret the Knicks have performed poorly over the past decade. On average,
you'd expect the Knicks to have a below 40% win percentage, placing them 3rd last in the NBA over this stretch.
```{r}
team_wins_df %>% 
  mutate(ToHighlight = ifelse(team_name == "Knicks", "yes", "no")) %>% 
  group_by(team_name, ToHighlight) %>% 
  summarise(avg_win_pct = mean(win_pct)) %>% 
  ggplot(aes(x = reorder(team_name, avg_win_pct),
             y = avg_win_pct,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Average win percentage of each NBA team (2013-2022)",
       x = "Team",
       y = "Average Win Percentage") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")
```

FURTHERMORE:

# Analysis 1: Sentiment Analysis

## Introduction: Fun analysis illustrating why the Knicks were poor through sentiment analysis:

This is the New York Knicks announcer sentiment. As seen 0.802 of words which
contain sentiment are negative, words like "miss", "bad" which imply Knicks games were
perhaps hard to watch with their poor performances throughout this period.

* Note: Might be a good place to make a user-defined function.
```{r}
play_by_play_df %>% 
  filter(player1_team_abbreviation == "NYK" | player2_team_abbreviation == "NYK" | player3_team_abbreviation == "NYK") %>% 
  select(game_id, homedescription) %>% 
  na.omit() %>% 
  unnest_tokens(
    output = word,
    input = homedescription,
    token = "words"
  ) %>% 
  anti_join(get_stopwords()) %>% 
  inner_join(get_sentiments("bing")) %>% 
  count(sentiment) %>% 
  mutate(proportion = n / sum(n))
```

Compare this to the league average (i.e. across all 30 teams):
Only a 0.750 negative sentiment. Knicks clearly aren't inspiring with their basketball.
```{r}
play_by_play_df %>% 
  select(game_id, homedescription) %>% 
  na.omit() %>% 
  unnest_tokens(
    output = word,
    input = homedescription,
    token = "words"
  ) %>% 
  anti_join(get_stopwords()) %>% 
  inner_join(get_sentiments("bing")) %>% 
  count(sentiment) %>% 
  mutate(proportion = n / sum(n))
```

But we already knew this, but the question is *WHY*?
What can be done in the future to bring the Knicks back into their glory days and win the support of the fans again?









# Analysis 2: Comparison of the Knicks 3P% against the rest of the leagues:


## Corrleation between 3P's and wins.

Key Takeaways:

* Considering all of the "common" NBA statistical measures such as assists, blocks, points, rebounds etc..., It's actually 3P% which affects winning the most with a 0.58 correlation. This is seen below when comparing each statistical measure's correlation with win percentage.

```{r}
cor_df <- all_team_stats %>% 
  select(win_pct, fg3_pct, reb, ast, stl, tov, blk, pts) %>% 
  cor_mat() %>% 
  gather(-rowname, key = cor_var, value = r)

cor_df %>% 
  ggplot(aes(x = rowname, y = cor_var, fill = r)) + 
  geom_tile() + 
  labs(x = "variables", y = "variables") + 
  scale_fill_gradient(low = "light yellow", high = "dark green") +
  geom_text(aes(label = r)) + 
  geom_segment(aes(x = 0.5,xend = 8.5,y = 7.5,yend = 7.5),colour="#FF4500", size = 1.5) + 
  geom_segment(aes(x = 0.5,xend = 8.5,y = 8.5,yend = 8.5),colour="#FF4500", size = 1.5) +
  geom_segment(aes(x = 0.5,xend = 0.5,y = 7.5,yend = 8.5),colour="#FF4500", size = 1.5) +
  geom_segment(aes(x = 8.5,xend = 8.5,y = 7.5,yend = 8.5),colour="#FF4500", size = 1.5)
```

To support above:

The following plot considers all 30 NBA teams for the ten seasons between 2013-2022 (i.e. 300 data points) and their
3 point percentage for that season against their win percentage. As theres 82 games played per season,
this is more than a sufficient sample size.

A moderate positive correlation is displayed.
```{r}
fg3_corr <- substr(as.character(cor(all_team_stats$win_pct, all_team_stats$fg3_pct)), start = 0, stop = 5)
all_team_stats %>% 
  ggplot(aes(x = fg3_pct, y = win_pct)) + 
  geom_point(color = "#ff48a5") + 
  labs(title = "Effect of 3 Point % on Winning",
       x = "3 Point Percentage",
       y = "Win Percentage") +
  geom_smooth(method = "lm", se = FALSE, color = "#89ABE3") +
  annotate(geom = "text", label = paste("r = ", fg3_corr), color = "#ff48a5", x = 0.33, y = 0.82, size = 6) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, size = 23))
```


^ With above demonstrating importance of 3P%, how have the Knicks performed? Could this explain our performance?

Firstly, lets compare the Knicks 3P% over time, and against league average. Apart from 2013, 2020 and 2021, the Knicks have been a below league 
average 3 point percentage shooting team for the 10 seasons measured.

```{r}
p1 <- all_team_stats %>% 
  group_by(year) %>% 
  summarise(league_3p_pct = mean(fg3_pct)) %>% 
  left_join(nyk_team_stats, by = "year") %>% 
  select(year, league_3p_pct, fg3_pct, win_pct) %>% 
  rename("knicks_3p_pct" = "fg3_pct", "knicks_win_pct" = "win_pct") %>% 
  pivot_longer(cols = c("league_3p_pct", "knicks_3p_pct"), names_to = "type", values_to = "three_pct") %>% 
  ggplot(aes(x = as.factor(year), y = three_pct, col = type, group = type)) +
  geom_line() + 
  geom_point() +
  theme_classic() + 
  labs(title = "Knicks 3P% Against League Average",
       x = "Year",
       y = "3 Point Percentage") +
  theme(plot.title = element_text(hjust = 0.5, size = 19))

ggplotly(p = p1)
```

Interestingly, Knicks 3P Attempts also are below that of league average for 3 of the ten recorded years.
Not only are we shooting sigifcantly less threes, we're also making significantly less threes.
Example: In 2019, when we won only (...) games, The Knicks shot 600 less threes than league average, winning only 31.8% of their games.
If this doesn't sound like a recipe for disaster in the modern NBA, I don't know what else does.

```{r}
p2 <- all_team_stats %>% 
  group_by(year) %>% 
  summarise(league_3s_attempted = mean(fg3a)) %>% 
  left_join(nyk_team_stats, by = "year") %>% 
  select(year, league_3s_attempted, fg3a) %>% 
  rename("knicks_threes_attempted" = "fg3a") %>% 
  pivot_longer(cols = c("league_3s_attempted", "knicks_threes_attempted"), names_to = "type", values_to = "threes_attempted") %>% 
  ggplot(aes(x = as.factor(year), y = threes_attempted, col = type, group = type)) +
  geom_line() + 
  geom_point() +
  theme_classic() + 
  labs(title = "Knicks 3 Pointers Attempted Against League Average",
       x = "Year",
       y = "3 Pointers attempted") +
  theme(plot.title = element_text(hjust = 0.5, size = 19))

ggplotly(p = p2)
```


**REDO**:
**CONCLUSION**: As seen in plot2, there has been a steady trend upwards in the number of 3's shot by NBA teams. 
However, the New York Knicks have been behind the ball in terms of 3 Pointers attempted compared to the league average.
Especially prevalant in 2018 where the Knicks 3P attempted plumetted way below league average. In this season,
the Knicks finished the season with an atrocious 17 wins, finishing last in the NBA that season. Perhaps the sudden increase in wins
could be explained by the significantly increased volume of threes shot under new head coach Tom Thibodeau, who joined the Knicks in 2020,
and led the Knicks to 2 playoffs births out of his 3 seasons in charge, even advancing to the conference semi-finals in the 2022 season.

As seen in plot1, the Knicks have been shooting poorly in terms of 3P% compared to the rest of the league, apart from the outliers in 2020 and
2013. This could be indicative of the Knicks poor performance but given the Knicks sudden rise to success from 2020 onwards, and the subsequent
decrease in 3P% by the Knicks, and in plot2, the significant rise in 3PA, it can be said that the Knicks are shooting more 3's, at a worse rate,
but are better off doing so.

I recognise that 3 Pointers are only one part of the game but with how integral it is to the modern NBA, it seems as if shooting more threes
one recipe that might contribute to success.



# Analysis 3: Checking salary of the Knicks players:

```{r}
league_salaries <- salaries %>% 
  group_by(season) %>% 
  summarise(league_salary = (sum(salary)/30) / 1000000)

knicks_salaries <- salaries %>% 
  filter(team == "New York Knicks") %>% 
  group_by(season) %>% 
  summarise(knicks_salary = sum(salary)/ 1000000)

league_salaries %>% 
  left_join(knicks_salaries) %>% 
  reshape2::melt(id.var = "season", variable.name = "Team") %>% 
  ggplot(aes(x = as.factor(season), y = value, fill = Team)) + 
  geom_col(position = "dodge", color = "black") +
  theme_classic() + 
  labs(title = "Knicks Total Salary Against League Average Total Salary",
       x = "Year",
       y = "Salary (in millions of dollars)")
```

The above plot shows me how the Knicks haven't been outrivaled by other NBA teams in terms of spending. Infact, we've been quite close
to league average and even surpassed it significantly in 2013/2014. It's only been in the past 4 years where the Knicks have started to see lower and lower salaries.

```{r}
all_team_stats <- all_team_stats %>% 
  mutate(team = paste(team_city, team_name, sep = " "),
         team = recode(team, "Los Angeles Clippers" = "LA Clippers")) %>% 
  rename("season" = "year")

salaries$season = as.numeric(salaries$season)

salary_vs_wins <- salaries %>% 
  left_join(all_team_stats, by = c("team", "season")) %>% 
  select(team, season, salary, win_pct)
```

Clearly, salary is not correlated with winning (i.e. Spending more money in the NBA doesn't necessarily mean you're better).

```{r}
salary_vs_wins %>% 
  ggplot(aes(salary, win_pct)) + 
  geom_point() + 
  labs(title = "Salary against Win Percentage",
       x = "Total Salary of a Team",
       y = "Win Percentage of a Team")
```


**CONCLUSION**: Clearly the Knicks keep with the league trend in spending. Both seem like they're on a linear progression upwards since 2016/2017 (new CBA).
However, ever since the 2017 CBA (Collective Bargaining Agreement), it seems the league salary has overtaken the Knicks salary.
Perhaps this is due to the 2017 CBA introducing higher max salaries. As the Knicks haven't had a player under a max contract
since Carmelo Anthony, who left in 2017, this could explain the Knicks trending under league average salary.

However, it can be seen that salary and the amount spent on players likely isn't a significant factor for the Knicks in terms of winning,
nor for any team (as seen in most recently created plot and its low correlation).
The Knicks have only performed well from 2019 onwards in this period, making the playoffs 2 out of 4 seasons,
where as from 2013-2019, a six year period the Knicks failed to make the playoffs even once.
From 2019 onwards, the Knicks have been significantly below league average in terms of spending.

Therefore, it can be said that better management of player contracts, allowing for flexibility in trades and free agency is key to improving the Knicks winning, not spending more.





## Potential Idea: Home court advantage??? Is it real. Are the Knicks performing poorly in this?

## Potential Idea: Other factors affecting???
```{r}
adv_cor_df <- team_metrics %>% 
  select(w_pct:e_tm_tov_pct) %>% 
  cor_mat() %>% 
  gather(-rowname, key = cor_var, value = r)
```

The variable that most stands out is the 0.97 e_net_rating. It comes as no surprise given e_net_rating's calculation.
**insert formula for it**. As it's just how many points you score against how many you concede. Of course, the more you score, and less you concede, the higher your win percentage as basketball is all about points. However, the two components of defensive and offensive efficiency rating can be looked deeper into on their own as they too have strong correlation with winning.

* Basically, both defensive and offensive rating appear to contribute equally to winning. Both encapsulated in net rating.



Lets explore how the Knicks are doing in either of these categories.

* Basically, see which of these 2 areas the Knicks should in particular focus on.

* To understand what net efficiency, defensive efficiency and offensive efficiency mean:

https://basketballnoise.com/how-to-calculate-defensive-efficiency/
https://bashabearsbasketball.com/what-is-net-efficiency-in-basketball/#:~:text=The%20formula%20for%20net%20efficiency,can%20be%20positive%20or%20negative.

```{r}
adv_cor_df %>% 
  ggplot(aes(x = rowname, y = cor_var, fill = r)) + 
  geom_tile() + 
  labs(x = "variables", y = "variables") + 
  scale_fill_gradient2(low = "#fb6767", high = "#3CB043") +
  geom_text(aes(label = r)) + 
  geom_segment(aes(x = 0.5,xend = 11.5,y = 11.5,yend = 11.5),colour="#FF4500", size = 1.5) + 
  geom_segment(aes(x = 0.5,xend = 11.5,y = 10.5,yend = 10.5),colour="#FF4500", size = 1.5) +
  geom_segment(aes(x = 0.5,xend = 0.5,y = 11.5,yend = 10.5),colour="#FF4500", size = 1.5) +
  geom_segment(aes(x = 11.5,xend = 11.5,y = 11.5,yend = 10.5),colour="#FF4500", size = 1.5)
```

Inspiration: Maybe try create a lollipop graph showing off_rating and defensive rating each year, deviating from the mean rating of 15?
https://r-graph-gallery.com/web-lollipop-plot-with-R-the-office.html


Conclusion: It's no secret that we need to work on both. In particular, 
an area of focus should be on our offensive efficiency as we're still trending in the low 20's in terms of offensive rank
prior to 2022, our best season in this stretch in terms of wins. Defensive efficiency needs work but as of late
after hiring a Defensive Minded coach in Tom Thibeadau in 2020, our Defense has been one of the best in the league. Small
dropoff in 2022 but our significant improvement to one of the best offenses in the league in 2022 helped to counter that,
achieving our best season in this 10 year stretch. 

* One area of improvement going forward is that we need to keep the momentum up. Historically, we've been better at defence
as so focus on maintaining our offense, and our defence will be at least close to leave average or better from past few years experience.


```{r}
team_metrics$year <- as.character(team_metrics$year)

offset <- 15

tmp <- team_metrics %>% 
  filter(team_name == "New York Knicks") %>% 
  select(year, e_off_rating_rank, e_def_rating_rank) %>% 
  mutate(e_off_rating_rank = e_off_rating_rank - offset,
         e_def_rating_rank = e_def_rating_rank - offset)

tmp %>% 
  ggplot(aes(x = year, y = e_off_rating_rank)) + 
  geom_col(aes(fill = e_off_rating_rank<0), position = "dodge", col = "transparent") + 
  scale_y_continuous(labels = function (x) x + offset) +
  theme_classic() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_segment(x = 0.55, xend = 10.45, y = 0, yend = 0) +
  labs(title = "Knicks offensive efficiency rank against league average",
       y = "offensive efficiency rank")

tmp %>% 
  ggplot(aes(x = year, y = e_def_rating_rank)) + 
  geom_col(aes(fill = e_def_rating_rank<0), position = "dodge", col = "transparent") + 
  scale_y_continuous(labels = function (x) x + offset) +
  theme_classic() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 15)) +
  geom_segment(x = 0.55, xend = 10.45, y = 0, yend = 0) +
  labs(title = "Knicks defensive efficiency rank against league average",
       y = "defensive efficiency rank")
```





Might just cut this part out.
# Analysis 5: Impacts of poor drafting by the New York Knicks.

Every year, NBA teams are given draft picks to select the best players coming out of college, or playing internationally that have
never entered the NBA draft before (i.e. usually young players around 18-22). These are pivotal selections that can change the trajectory
of an NBA franchise as all NBA greats once were selected by an NBA team. Teams who performed poorly in terms of standings have higher selections
than those who performed well, allowing these poor teams to attempt to draft impactful players as it's usually only those high selections
that have servicable NBA careers.

One would imagine that the New York Knicks, a franchise that is 3rd last in terms of wins since 2013 would have high draft
picks and hence, would select the best up and coming young players. Whilst the Knicks have had high draft picks, have they been using their
coveted high picks to select players who contribute to winning? In this section, we explore the Knicks drafting of players since 2013
which might perhaps contribute to the Knicks failures. 

Choice of statistic (i.e. to measure how well a draft pick has played in their NBA career): Net Rating: Measures a team's
point differential per 100 persons (i.e. how many points does a player add/remove per 100 possessions)?
Basically, how much better off is a team with the player on the court compared to without? Positive means better with them on the court. Negative
means worse off with that player on the court.

**Preparing data**
```{r}
player_rating <- player_info %>% 
  select(player_name, season, net_rating) %>% 
  group_by(player_name) %>% 
  summarise(career_net_rating = mean(net_rating))

draft_picks <- draft_history_df %>% 
  filter(season > 2012) %>% 
  select(person_id, player_name, season, round_number, round_pick, overall_pick, team_abbreviation, organization, organization_type) %>% 
  mutate(organization_type = recode(organization_type, "Other Team/Club" = "International", "College/University" = "College")) %>% 
  filter(!is.na(organization_type)) %>% 
  left_join(player_rating, by = "player_name")

player_rating
draft_picks
```

4th Worst using 1st round picks. On average, 8th Highest pick assuming 1st round picks.
Considered only 1st round picks because usually those players are the ones that make the difference to a franchise.

Interpretation: So we're selecting very high (i.e. top 8 on average between 2013-2022) (plot 1), which 
should lead to us selecting the better players earlier but we're using our picks poorly (26th best) in terms of avg net rating from drafted players.
Not such great return on value huh? Why might this be the case (plot2)?
```{r}
p1 <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  filter(round_number == 1) %>% 
  group_by(team_abbreviation) %>% 
  summarise(avg_net_rating = mean(career_net_rating, na.rm = TRUE)) %>% 
  arrange(avg_net_rating) %>% 
  mutate(ToHighlight = ifelse(team_abbreviation == "NYK", "yes", "no")) %>% 
  ggplot(aes(x = reorder(team_abbreviation, avg_net_rating),
             y = avg_net_rating,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Avg Net Rating of 1st Round Draftees by Team (2013-2022)",
       x = "Team",
       y = "Average Net Rating") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")
  

p2 <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  filter(round_number == 1) %>% 
  group_by(team_abbreviation) %>% 
  summarise(avg_pick_number = mean(overall_pick, na.rm = TRUE)) %>% 
  arrange(avg_pick_number) %>% 
  mutate(ToHighlight = ifelse(team_abbreviation == "NYK", "yes", "no")) %>% 
  ggplot(aes(x = reorder(team_abbreviation, -avg_pick_number),
             y = avg_pick_number,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Avg 1st Round Pick Number by Team (2013-2022)",
       x = "Team",
       y = "Average 1st Round Pick Number") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")

plot_grid(p2, p1)
```

As college players make up around 4/5th of total drafted players, lets dive deeper into the Knicks selections
of college players over the past decade:
```{r}
draft_picks %>% 
  count(organization_type)
```

But why is it that the Knicks are drafting worse players than the other teams when they have significantly higher picks (i.e. under performing with picks)?

## Perhaps due to the colleges selected from?

## NOTE: THE BELOW SECTION RELATES TO ALL TEAMS, NOT JUST THE KNICKS AND HOW TO IMPROVE DRAFTING. BUT ESPECIALLY RELEVANT
## FOR THE KNICKS CONSIDERING THEIR POOR DRAFTING HISTORY IN THE PAST DECADE.

Firstly, it must be noted that we're only considering colleges that have had 7 or more NBA draft picks in the past decade. 
Colleges with a small number of drafted players don't have a sufficient sample size in the NBA confidently determine the
performance of that colleges players in the NBA.

**NOTE: COULD TRY TO IMPLEMENT A BETTER LOWER LIMIT SIZE OF 5 USING STATISTICS!!!**

As seen, these are the top ten colleges in terms of average college net rating of drafted players in the NBA.
If you notice anything about these colleges, they all have relatively strong reputations in the college game
for being powerhouse basketball schools, having won a total of 35 national championships between them,
out of a possible 61. Considering there's a possible 351 college teams, these ten colleges clearly are 
some of the biggest out winning 57% of all national championships in history.
```{r}
top_ten_colleges <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  group_by(organization) %>% 
  mutate(n = n()) %>% 
  filter(n >= 7) %>% 
  summarise(avg_college_net_rating = mean(career_net_rating, na.rm = TRUE)) %>% 
  slice_max(order_by = avg_college_net_rating, n = 10)

top_ten_colleges
```

**VERY IMPORTANT NOTE TO MENTION**: THESE ARE SIMPLY ONE FACTOR THAT DETERMINES WINNING. THUS, IT'S HIGHLY UNLIKELY EITHER PLOTS HAVE A MASSIVE
CORRELATION WITH WINNING AND THEREFORE, A 0.10 CORRELATION AND VISIBLE DIFFERENT IN PLOTS IS IMPORTANT TO ANALYSE AND NOTICE
THE DIFFERENCE IN POTENTIALLY DRAFTING FROM POWERHOUSE COLLEGES VS INTERNATIONAL.


Clearly, no meaningful correlation between the number of selections a team makes against their win percentage. So what part
of the draft might actually influence a teams ability to win?
```{r}
team_wins_df2 <- team_wins_df %>% 
  select(team_id, team_abbreviation, total_win_percentage)

college_winning <- draft_picks %>% 
  filter(organization %in% top_ten_colleges$organization) %>% 
  group_by(team_abbreviation) %>% 
  summarise(top_ten_college_selections = n()) %>% 
  arrange(desc(top_ten_college_selections)) %>% 
  left_join(team_wins_df2) %>% 
  select(-team_id)

correlation_college <- substr(as.character(cor(college_winning$total_win_percentage, college_winning$top_ten_college_selections)), start = 0, stop = 6)

college_winning %>% 
  ggplot(aes(x = top_ten_college_selections, y = total_win_percentage)) + 
  geom_point() + 
  geom_smooth(se = FALSE) + 
  annotate(geom = "text", label = paste("correlation = ", correlation_college), color = "blue", x = 6, y = 60, size = 5) + 
  labs(title = "Effects of Drafting International Players on Winning %",
       x = "International Players Drafted (%)",
       y = "Winning Percentage") + 
  theme_classic()
```

Perhaps we could look into the effects on winning from drafting more international players?

Moderate degree of negative correlation between total_win_percentage and international drafted players. It seems as if you tend to win less
the more International players you draft.


```{r}
intenational_winning_df <- draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  count(team_abbreviation, organization_type) %>% 
  pivot_wider(names_from = organization_type, values_from = n) %>% 
  group_by(team_abbreviation) %>% 
  mutate(International = ifelse(is.na(International), 0, International)) %>%             # Accounting for LAC having drafted 0 International players.
  summarise(international_percent = International / (College + International) * 100) %>%
  left_join(team_wins_df2, on = "team_abbreviation")

correlation <- substr(as.character(cor(intenational_winning_df$total_win_percentage, intenational_winning_df$international_percent)), start = 0, stop = 6)

intenational_winning_df %>% 
  ggplot(aes(x = international_percent, y = total_win_percentage)) + 
  geom_point() + 
  geom_smooth(se = FALSE) + 
  annotate(geom = "text", label = paste("correlation = ", correlation), color = "blue", x = 23, y = 60, size = 5) + 
  labs(title = "Effects of Drafting International Players on Winning %",
       x = "International Players Drafted (%)",
       y = "Winning Percentage") + 
  theme_classic()
```

So If there is NO MEAINGFUL CORRELATION between winning percentage and the college program you draft from and there is only MODERATE
negative correlation between winning percentage and the percentage of International players you select, what is actually important?



It seems pretty obvious right? Selecting the right players with your picks.



As a further interesting note, despite drafting International players having a moderately *negative correlation* with winning percentage,
we shouldn't just not draft International players. 

* For one, it a only a moderately strong negative correlation.
* But more importantly, this data contains data on ALL INTERNATIONAL PLAYERS. Why is this of importance? International players
  as seen below are typically drafted lower than college players. Perhaps due to biases? Lack of exposure to NBA scouts? A multiple of reasons.
  

Interpretation: International players are selected on average, 4.3 picks lower than college players.

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>% 
  summarise(avg_pick_number = mean(overall_pick, na.rm = TRUE))
```


Looking further into the data, if we were to select between a College and International player, who really should we select
given selecting college players from a big program has a better correlation with winning compared to that of selecting International players?


## Are Non-College (i.e. International players) better than College players in terms of avg_net_rating?
* Compare the two and see if College or Non-College players make the bigger impact?
* Then see what demographic the knicks are primarily drafting (pie-chart). College or non-college. 
* If Non-college are making the bigger impact and Knicks are drafting more college than league avg, perhaps this is a recommendation.

As seen, draft Picks usually come from college or played professionally. Therefore, it might be worthwhile comparing the performance
of players coming from college against those coming from professional ball.
```{r}
draft_picks %>% 
  count(organization_type)
```

Interpreation: To get an overview of performance of College vs International players,
clearly the avg_rating for International players is lower than that of College players,
but the sd is higher.

This indicates that perhaps International players have a greater spread of performance, with it being more risky
to select International players due to lower average rating but it yielding potentially greater rewards
with the spread of performance being so high. It seems as if college players are the safer choice, but for more
reward, you'd select International.

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>%
  summarise(sd_rating = sd(career_net_rating, na.rm = TRUE),
            avg_rating = mean(career_net_rating, na.rm = TRUE))
```

To analyse the above further, we can look into the *quantiles*:

Interpretation: It can be seen that College the Q1 and Median college drafted played in terms for average net rating will perform
better than that of the internationally drafted player. However, the Q3 and top 10% of performing draft picks for professional players
will perform better than that of their college counterpart.  
Furthermore, it can be seen that as you increase the quantile, the international players start to increase their avg_rating relative to 
that of college players.

This suggests that drafted international players have much higher potential to be impactful players or even stars in the NBA,
which holds in line with current NBA trends as the past 4 out of 5 MVP (Most Value Player) awards have been handed to 
Giannis and Jokic, who both played internationally prior to entering the NBA.

This suggests that international players who make a difference (i.e. are in the top 25% or 10% of 
professionally drafted players) make a *larger* difference than their college counterparts can be explained by the position 
in which these players were selected.

However, on the contrary, International players who fail to make a meaningful different seem to perform worse
than their college counterparts (i.e. players in the bottom 25% or bottom 50% of net rating).

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>% 
  summarise_at(vars(career_net_rating),
              list(Q1=~quantile(., probs = 0.25, na.rm = TRUE),
                    median=~median(.x, na.rm = TRUE), Q3=~quantile(., probs = 0.75, na.rm = TRUE),
                   top_decile = ~quantile(., probs = 0.9, na.rm = TRUE)))
```


Interpretation: As seen in the graph, the Knicks are 2nd in terms of International players drafted, with 35.3% of our draft picks being International.
Furthermore, alot of these picks have been high draft picks, as we've performed poorly in the since 2013 however, why did the Knicks still perform
poorly if we're selecting a lot of International players highly?

Simply select International players highly, but rather good recruitment is required. 

Take for example Denver, who are the 3rd highest international drafted with 31.6% of draftees coming from International basketball.
They however, won the 2022/2023 NBA championship with Nikola Jokic, their best player and one of the best players in NBA history
coming from International.

Therefore, I propose the Knicks really focus in on their drafting process and consider what qualities in International players
would help them succeed when transitioning into the NBA. 
