---
title: "Exploring The Failures of The New York Knicks"
author: "Daniel Liu"
date: "27/06/2023"
output: 
  html_document: 
    fig_caption: yes
---

```{r setup, warning=FALSE, error=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stopwords)
library(tidyverse)
library(tidytext)
library(textdata)
library(lubridate)
library(cowplot)
library(polite)
library(rvest)
library(janitor)
library(data.table)
library(formattable)
```

# Analysis using nba_api dataframes:
```{r}
all_team_stats <- read_csv(here::here("nba_data", "all_team_stats.csv"))
glimpse(all_team_stats)
nyk_team_stats <- read_csv(here::here("nba_data", "nyk_team_stats.csv"))
team_metrics <- read_csv(here::here("nba_data", "team_metrics.csv"))
glimpse(team_metrics)
```

Look at the correlation between different things. Maybe using those that most correlate, try
to use a Linear Model to predict a teams success. Try to predict the Knicks future success?

Use all_team_stats instead of all the previous dfs. Better now. Shows wins/losses much easier!!!

Use team_metrics as interesting statistics to look at and see their importance.

**NOTE**: Could try to add in the Python code here.




















# Introduction

As a "junior data analyst" working in the basketball analytics team for Hudl, a sports analytics company specializing in improving team performance, I am tasked with gaining insight into why the New York Knicks have disappointed over the past decade in the NBA. The insights I uncover will then be presented to a New York Knicks representative to help uncover key areas of improvement to hopefully win more games. I will approach this taks through the [https://www.geeksforgeeks.org/six-steps-of-data-analysis-process/](Six Steps of Data Analysis Process).

# Ask

In this stage, I consider questions that might offer insights into the Knicks failures from 2013-2022.

### Questions of Interest
1. How has the rise in popularity of the 3 point shot impacted the Knicks?
2. Does the team salary play a role in the success of a team?
3. What players should the Knicks focus on drafting for greater success?

# Prepare 

I used two datasets. Firstly, [https://www.kaggle.com/datasets/wyattowalsh/basketball](NBA Database) is a dataset containing statistics on all 30 NBA teams, 4800+ NBA players and 60,000+ NBA games throughout history. Secondly, [https://www.kaggle.com/datasets/jarosawjaworski/current-nba-players-contracts-history](NBA Salaries) is a dataset containing NBA player salaries between 2010-2020.

Through exploring and understand each dataset, I identified 7 datasets from the NBA Database that are suitable for the purposes of this analysis. Furthermore, the salaries dataset only goes up to 2020, whereas this analysis goes up till 2022. To resolve this lack of data, I scraped data from [https://www.spotrac.com/nba/cap/2022/](spotrac) to obtain NBA team salaries between 2021-2022.  

***

Importing required files

```{r results='hide'}
draft_history_df <- read_csv(here::here("nba_data", "draft_history.csv"))
game_info_df <- read_csv(here::here("nba_data", "game_info.csv"))
game_df <- read_csv(here::here("nba_data", "game.csv"))
play_by_play_df <- read_csv(here::here("nba_data", "play_by_play.csv"))
common_player_info_df <- read_csv(here::here("nba_data", "common_player_info.csv"))
team_df <- read_csv(here::here("nba_data", "team.csv"))
glimpse(team_df)
player_info <- read_csv(here::here("nba_data", "all_seasons.csv"))
salaries <- read_csv(here::here("nba_data", "nba_salaries.csv"))
```


# Process

I get combine individual player salaries into 30 NBA team salaries to keep the analysis consistent on teams throughout, rather than players.

```{r results='hide'}
salaries <- salaries %>% 
  select(team, salary, season) %>% 
  filter(season >= 2013) %>% 
  filter(!(team %in% c("Fenerbahce Ulker Fenerbahce Ulker", "Maccabi Haifa Maccabi Haifa", "null Unknown",
                       "Madrid Real Madrid", "Charlotte Bobcats", "New Orleans Hornets"))) %>% 
  group_by(team, season) %>% 
  summarize(salary = sum(salary))
```

Next, I perform web-scraping to get 2021 and 2022 NBA salary data.

```{r}
scrape_salaries <- function(html_link, year){
  page <- read_html(html_link)
  table <- page %>% 
    html_table() %>% 
    data.frame() %>% 
    as_tibble() %>% 
    select(Team, Total.Cap) %>% 
    rename("salary" = "Total.Cap",
         "team" = "Team") %>% 
    mutate(across("salary", ~gsub("\\$", "", .))) %>% 
    mutate(across("salary", ~gsub("\\,", "", .))) %>% 
    mutate(season = year)
  
  table$salary <- as.numeric(table$salary)
  
  returned_df <- salaries %>% 
    bind_rows(table)
  
  return(returned_df)
  
}

salaries <- scrape_salaries("https://www.spotrac.com/nba/cap/2022/", 2022)
salaries <- scrape_salaries("https://www.spotrac.com/nba/cap/2021/", 2021)
```

As the analysis is conducted between 2013-2022, I filter for data from 29/10/2013 (start of 2013 NBA season) till present.

```{r results='hide'}
game_df$game_date <- as.Date(game_df$game_date)
game_df$season_id <- as.character(game_df$season_id)
game_df <- game_df %>%
  filter(game_date > "2013-10-29") %>% 
  mutate(year = substring(season_id, 2))

game_info_df$game_date <- as.Date(game_info_df$game_date)
game_info_df <- game_info_df %>% 
  na.omit() %>% 
  mutate(year = year(game_date)) %>% 
    filter(game_date > "2013-10-29")

play_by_play_df <- game_df %>% 
  select(game_id, game_date) %>% 
  right_join(play_by_play_df, on = "game_id") %>% 
  filter(game_date > "2013-10-29")
```

For the analysis, I require information on each of the 30 teams wins and losses. As such data was not provided, I wrangle the `game_df` which provides information on every game between 2013-2022 to become each teams wins at home, away and in total.

```{r}
# Home team wins:
home_team_wins <- game_df %>% 
  rename(team_id = team_id_home, team_abbreviation = team_abbreviation_home) %>% 
  group_by(team_id, team_abbreviation) %>% 
  summarise(home_wins = sum(wl_home == "W", na.rm = TRUE),
            home_losses = sum(wl_home == "L", na.rm = TRUE),
            home_win_proportion = home_wins / (home_losses + home_wins))

# Away team wins:
away_team_wins <- game_df %>% 
  rename(team_id = team_id_away, team_abbreviation = team_abbreviation_away) %>% 
  group_by(team_id, team_abbreviation) %>% 
  summarise(away_wins = sum(wl_away == "W", na.rm = TRUE),
            away_losses = sum(wl_away == "L", na.rm = TRUE),
            away_win_proportion = away_wins / (away_losses + away_wins))

# Total wins
team_wins_df <- home_team_wins %>% 
  inner_join(away_team_wins, by = c("team_id", "team_abbreviation")) %>% 
  mutate(total_wins = home_wins + away_wins,
         total_losses = home_losses + away_losses,
         total_win_percentage = total_wins / (total_wins + total_losses) * 100) %>% 
  select(-home_losses, -home_wins, -away_wins, -away_losses)
  
formattable(head(team_wins_df, 6))
```

# Analyze: 

Please note that team abbreviations will be used in data frames and visualizations. A list of team abbrevations and their full names can be found [https://en.wikipedia.org/wiki/Wikipedia:WikiProject_National_Basketball_Association/National_Basketball_Association_team_abbreviations](here).

***

# FROM HERE ON, I HAVEN'T STARTED FINALIZING THE REPORT.

It's not secret the Knicks have performed poorly over the past decade. As seen below, the Knicks are the 3rd worst team with a below 50 win percentage
between 2013 and 2022.
```{r}
team_wins_df %>% 
  mutate(ToHighlight = ifelse(team_abbreviation == "NYK", "yes", "no")) %>% 
  ggplot(aes(x = reorder(team_abbreviation, total_win_percentage),
             y = total_win_percentage,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Win percentage of each NBA team (2013-2022)",
       x = "Team",
       y = "Win Percentage") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")
```

FURTHERMORE:

# Analysis 1: Sentiment Analysis

## Introduction: Fun analysis illustrating why the Knicks were poor through sentiment analysis:

This is the New York Knicks announcer sentiment. As seen 0.802 of words which
contain sentiment are negative, words like "miss", "bad" which imply Knicks games were
perhaps hard to watch with their poor performances throughout this period.

* Note: Might be a good place to make a user-defined function.
```{r}
play_by_play_df %>% 
  filter(player1_team_abbreviation == "NYK" | player2_team_abbreviation == "NYK" | player3_team_abbreviation == "NYK") %>% 
  select(game_id, homedescription) %>% 
  na.omit() %>% 
  unnest_tokens(
    output = word,
    input = homedescription,
    token = "words"
  ) %>% 
  anti_join(get_stopwords()) %>% 
  inner_join(get_sentiments("bing")) %>% 
  count(sentiment) %>% 
  mutate(proportion = n / sum(n))
```

Compare this to the league average (i.e. across all 30 teams):
Only a 0.750 negative sentiment. Knicks clearly aren't inspiring with their basketball.
```{r}
play_by_play_df %>% 
  select(game_id, homedescription) %>% 
  na.omit() %>% 
  unnest_tokens(
    output = word,
    input = homedescription,
    token = "words"
  ) %>% 
  anti_join(get_stopwords()) %>% 
  inner_join(get_sentiments("bing")) %>% 
  count(sentiment) %>% 
  mutate(proportion = n / sum(n))
```

But we already knew this, but the question is *WHY*?
What can be done in the future to bring the Knicks back into their glory days and win the support of the fans again?




# Analysis 2: Comparison of the Knicks 3P% against the rest of the leagues:

## It's no secret that there has been an explosion of 3 Pointers in the past few decades, with the likes of Steph 
## Curry and revoluntising the game from beyond the arc. In this section, I explore the performance and impact
## that the three point shot has had on the New York Knicks since 2013.

Firstly: Preparatory step. For each of the 30 teams, have their home_game_stats, away_game_stats and all_game_stats in a dataframe.

Explain how each team now has all their games played in all_games_stats as a tibble containing details on the game in the all_game_stats column.
```{r}
# Obtaining every game that every team has played in:
glimpse(game_df)
glimpse(team_df)

# Obtains a dataframe containing each teams home_game_stats in a column:
team_df2 <- team_df %>% 
  select(id, full_name, abbreviation) %>% 
  left_join(game_df, by = c("id" = "team_id_home")) %>% 
  nest(home_game_stats = c(-id, -full_name, -abbreviation))

team_df2

# Adds onto the dataframe each teams away_game_stats in a column:
team_df2 <- team_df2 %>% 
  left_join(game_df, by = c("id" = "team_id_away")) %>% 
  nest(away_game_stats = c(-id, -full_name, -abbreviation, -home_game_stats))

# Adds onto the dataframe each teams away_game_stats in a column: For each team, combine their home_game_stats and away_game_stats
add_all_stats <- function(home_game_stats, away_game_stats){
  list(bind_rows(team_df2$home_game_stats[1], team_df2$away_game_stats[1]))
}

team_df2

# Adds onto the dataframe a column which contains statistics on each game played by each team:\
team_df2$all_game_stats <- NA    # Initialize empty column

for (x in 1:30) {
  team_df2$all_game_stats[x] <- list(bind_rows(team_df2$home_game_stats[x], team_df2$away_game_stats[x]))
}

team_df2
```



Secondly, for the New York Knicks (filtering), consider their games played between 2013-2022
```{r}
# A dataframe on all the New York Knicks Games Played between 2013-2022:
knicks_games <- team_df2 %>% 
  filter(abbreviation == "NYK") %>% 
  select(all_game_stats) %>% 
  unnest(cols = c(all_game_stats))
```

Look at the trend of 3 point % over time for the knicks against how many wins we had that season.
NOTE: Knicks abbreviation is "NYK"
```{r}
# Focus is on 3 points attempted + made:
knicks_threes <- knicks_games %>% 
  select(year, team_abbreviation_home, wl_home, fg3a_home, fg3m_home, team_abbreviation_away, wl_away, fg3a_away, fg3m_away, wl_home, wl_away)

knicks_threes

# Obtain a column containing the number of 3 pointers made + attempted per game for every Knicks game between 2013-2022:
knicks_threes <- knicks_threes %>% 
  mutate(
    knicks_3a = case_when(
    team_abbreviation_home == "NYK" ~ fg3a_home,
    TRUE ~ fg3a_away
  ),
    knicks_3m = case_when(
    team_abbreviation_home == "NYK" ~ fg3m_home,
    TRUE ~ fg3m_away
  ))

# Obtain a column containing whether the knicks won that game or not (1 = win, 0 = loss):
knicks_threes <- knicks_threes %>% 
  mutate(
    knicks_win = case_when(
    (team_abbreviation_home == "NYK") & (wl_home == "W") ~ 1,
    (team_abbreviation_home == "NYK") & (wl_home == "L") ~ 0,
    (team_abbreviation_away == "NYK") & (wl_away == "W") ~ 1,
    TRUE ~ 0
    ))


# Calculating for each year, the knicks 3P% by summing up 3's attempted / 3's made that year:
# Note: Missing 2017 Data. MAKE MENTION IN MY REPORT. DATA NOT SO GOOD?
knicks_threes <- knicks_threes %>% 
  group_by(year) %>% 
  summarise(knicks_3p_percent = (sum(knicks_3m) / sum(knicks_3a)) * 100,
            knicks_3p_attemped = sum(knicks_3a))
```

Compare the Knicks total 3 point % over 2013-2022 compared to the rest of the league.
```{r}
# Performing same steps as above but now on all teams to get a league average:
all_teams_threes <- game_df %>% 
  select(year, team_abbreviation_home, wl_home, fg3a_home, fg3m_home, team_abbreviation_away, wl_away, fg3a_away, fg3m_away)

all_teams_threes <- all_teams_threes %>% 
  mutate(total_game_fg3a = fg3a_home + fg3a_away,
         total_game_fg3m = fg3m_home + fg3m_away)

all_teams_threes

all_teams_threes <- all_teams_threes %>% 
  group_by(year) %>% 
  summarise(all_teams_3p_percent = (sum(total_game_fg3m) / sum(total_game_fg3a)) * 100,
            avg_teams_3p_attempted = sum(total_game_fg3a) / 30)

all_teams_threes
```

Creating a visualization of 3P% by year of league average vs knicks:

Plot: Knicks 3P% against league average: For most seaasons, apart from 3 outliers, much lower.
```{r}
knicks_threes %>%
  left_join(all_teams_threes) %>% 
  select(-knicks_3p_attemped, -avg_teams_3p_attempted) %>% 
  reshape2::melt(id.var = "year", variable.name = "Teams") %>% 
  ggplot(aes(x = as.factor(year),y = value, col = Teams, group = Teams)) + 
  geom_line() +
  geom_point() +
  theme_classic() + 
  labs(title = "Knicks 3P% Against League Average",
       x = "Year",
       y = "3 Point Percentage") + 
  ylim(33, 40)
```

```{r}
knicks_threes %>% 
  left_join(all_teams_threes) %>% 
  select(-knicks_3p_percent, -all_teams_3p_percent) %>% 
  reshape2::melt(id.var = "year", variable.name = "Teams") %>% 
  ggplot(aes(x = as.factor(year),y = value, col = Teams, group = Teams)) + 
  geom_line() +
  geom_point() +
  theme_classic() + 
  labs(title = "Knicks 3P Attempted Against League Average",
       x = "Year",
       y = "3 Pointers Attempted")
```


**CONCLUSION**: As seen in plot2, there has been a steady trend upwards in the number of 3's shot by NBA teams. 
However, the New York Knicks have been behind the ball in terms of 3 Pointers attempted compared to the league average.
Especially prevalant in 2018 where the Knicks 3P attempted plumetted way below league average. In this season,
the Knicks finished the season with an atrocious 17 wins, finishing last in the NBA that season. Perhaps the sudden increase in wins
could be explained by the significantly increased volume of threes shot under new head coach Tom Thibodeau, who joined the Knicks in 2020,
and led the Knicks to 2 playoffs births out of his 3 seasons in charge, even advancing to the conference semi-finals in the 2022 season.

As seen in plot1, the Knicks have been shooting poorly in terms of 3P% compared to the rest of the league, apart from the outliers in 2020 and
2013. This could be indicative of the Knicks poor performance but given the Knicks sudden rise to success from 2020 onwards, and the subsequent
decrease in 3P% by the Knicks, and in plot2, the significant rise in 3PA, it can be said that the Knicks are shooting more 3's, at a worse rate,
but are better off doing so.

I recognise that 3 Pointers are only one part of the game but with how integral it is to the modern NBA, it seems as if shooting more threes
one recipe that might contribute to success.


# Analysis 3: Checking salary of the Knicks players:
```{r}
league_salaries <- salaries %>% 
  group_by(season) %>% 
  summarise(league_salary = (sum(salary)/30) / 1000000)

knicks_salaries <- salaries %>% 
  filter(team == "New York Knicks") %>% 
  group_by(season) %>% 
  summarise(knicks_salary = sum(salary)/ 1000000)

league_salaries %>% 
  left_join(knicks_salaries) %>% 
  reshape2::melt(id.var = "season", variable.name = "Team") %>% 
  ggplot(aes(x = as.factor(season), y = value, col = Team, group = Team)) + 
  geom_line() +
  geom_point() +
  theme_classic() + 
  labs(title = "Knicks Total Salary Against League Average Total Salary",
       x = "Year",
       y = "Salary (in millions of dollars)")
```

```{r}
# Preparatory df, can hide this If I choose to.
team_wins_df
team_df
salaries

all_seasons_home_wins <- game_df %>% 
  rename(team_id = team_id_home, team_abbreviation = team_abbreviation_home) %>% 
  group_by(team_id, team_abbreviation, year) %>% 
  summarise(home_wins = sum(wl_home == "W", na.rm = TRUE),
            home_losses = sum(wl_home == "L", na.rm = TRUE),
            home_win_proportion = home_wins / (home_losses + home_wins))

all_seasons_away_wins <- game_df %>% 
  rename(team_id = team_id_away, team_abbreviation = team_abbreviation_away) %>% 
  group_by(team_id, team_abbreviation, year) %>% 
  summarise(away_wins = sum(wl_away == "W", na.rm = TRUE),
            away_losses = sum(wl_away == "L", na.rm = TRUE),
            away_win_proportion = away_wins / (away_losses + away_wins))

# Combining two df's for each team and add variables (total_wins) and (total_losses)
all_seasons_team_wins <- all_seasons_home_wins %>% 
  inner_join(all_seasons_away_wins, by = c("team_id", "team_abbreviation", "year")) %>% 
  mutate(total_wins = home_wins + away_wins,
         total_losses = home_losses + away_losses,
         total_win_percentage = total_wins / (total_wins + total_losses) * 100)
```

Creating a dataframe with the year, team, salary and total_win_percentage that season:
```{r}
salaries$season <- as.character(salaries$season)

salary_vs_wins <- salaries %>% 
  mutate(team = recode(team, "LA Clippers" = "Los Angeles Clippers")) %>% 
  left_join(team_df, by = c("team" = "full_name")) %>% 
  group_by(team, season, id) %>% 
  summarize(mean_salary = mean(salary)) %>% 
  left_join(all_seasons_team_wins, by = c("id" = "team_id", "season" = "year")) %>% 
  select(mean_salary, season, team_abbreviation, total_win_percentage) %>% 
  na.omit() 

salary_vs_wins %>% 
  View()
```

Clearly, salary is not correlated with winning (i.e. Spending more money in the NBA doesn't necessarily mean you're better).
```{r}
salary_vs_wins %>% 
  ggplot(aes(mean_salary, total_win_percentage)) + 
  geom_point() + 
  labs(title = "Salary against Win Percentage",
       x = "Total Salary of a Team",
       y = "Win Percentage of a Team")

cor(salary_vs_wins$mean_salary, salary_vs_wins$total_win_percentage)
```


**CONCLUSION**: Clearly the Knicks keep with the league trend in spending. Both seem like they're on a linear progression upwards since 2016/2017 (new CBA).
However, ever since the 2017 CBA (Collective Bargaining Agreement), it seems the league salary has overtaken the Knicks salary.
Perhaps this is due to the 2017 CBA introducing higher max salaries. As the Knicks haven't had a player under a max contract
since Carmelo Anthony, who left in 2017, this could explain the Knicks trending under league average salary.

However, it can be seen that salary and the amount spent on players likely isn't a significant factor for the Knicks in terms of winning,
nor for any team (as seen in most recently created plot and its low correlation).
The Knicks have only performed well from 2019 onwards in this period, making the playoffs 2 out of 4 seasons,
where as from 2013-2019, a six year period the Knicks failed to make the playoffs even once.
From 2019 onwards were the only times the Knicks salaries were a sizeable amount number league average.
This is likely because of the better management of players and player contracts.

Therefore, it can be said that better management of player contracts, allowing for flexibility in trades and free agency is key to improving the Knicks winning.


# Analysis 4: Impacts of poor drafting by the New York Knicks.

Every year, NBA teams are given draft picks to select the best players coming out of college, or playing internationally that have
never entered the NBA draft before (i.e. usually young players around 18-22). These are pivotal selections that can change the trajectory
of an NBA franchise as all NBA greats once were selected by an NBA team. Teams who performed poorly in terms of standings have higher selections
than those who performed well, allowing these poor teams to attempt to draft impactful players as it's usually only those high selections
that have servicable NBA careers.

One would imagine that the New York Knicks, a franchise that is 3rd last in terms of wins since 2013 would have high draft
picks and hence, would select the best up and coming young players. Whilst the Knicks have had high draft picks, have they been using their
coveted high picks to select players who contribute to winning? In this section, we explore the Knicks drafting of players since 2013
which might perhaps contribute to the Knicks failures. 

Choice of statistic (i.e. to measure how well a draft pick has played in their NBA career): Net Rating: Measures a team's
point differential per 100 persons (i.e. how many points does a player add/remove per 100 possessions)?
Basically, how much better off is a team with the player on the court compared to without? Positive means better with them on the court. Negative
means worse off with that player on the court.

**Preparing data**
```{r}
player_rating <- player_info %>% 
  select(player_name, season, net_rating) %>% 
  group_by(player_name) %>% 
  summarise(career_net_rating = mean(net_rating))

draft_picks <- draft_history_df %>% 
  filter(season > 2012) %>% 
  select(person_id, player_name, season, round_number, round_pick, overall_pick, team_abbreviation, organization, organization_type) %>% 
  mutate(organization_type = recode(organization_type, "Other Team/Club" = "International", "College/University" = "College")) %>% 
  filter(!is.na(organization_type)) %>% 
  left_join(player_rating, by = "player_name")

player_rating
draft_picks
```

4th Worst using 1st round picks. On average, 8th Highest pick assuming 1st round picks.
Considered only 1st round picks because usually those players are the ones that make the difference to a franchise.

Interpretation: So we're selecting very high (i.e. top 8 on average between 2013-2022) (plot 1), which 
should lead to us selecting the better players earlier but we're using our picks poorly (26th best) in terms of avg net rating from drafted players.
Not such great return on value huh? Why might this be the case (plot2)?
```{r}
p1 <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  filter(round_number == 1) %>% 
  group_by(team_abbreviation) %>% 
  summarise(avg_net_rating = mean(career_net_rating, na.rm = TRUE)) %>% 
  arrange(avg_net_rating) %>% 
  mutate(ToHighlight = ifelse(team_abbreviation == "NYK", "yes", "no")) %>% 
  ggplot(aes(x = reorder(team_abbreviation, avg_net_rating),
             y = avg_net_rating,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Avg Net Rating of 1st Round Draftees by Team (2013-2022)",
       x = "Team",
       y = "Average Net Rating") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")
  

p2 <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  filter(round_number == 1) %>% 
  group_by(team_abbreviation) %>% 
  summarise(avg_pick_number = mean(overall_pick, na.rm = TRUE)) %>% 
  arrange(avg_pick_number) %>% 
  mutate(ToHighlight = ifelse(team_abbreviation == "NYK", "yes", "no")) %>% 
  ggplot(aes(x = reorder(team_abbreviation, -avg_pick_number),
             y = avg_pick_number,
             fill = ToHighlight)) +
  geom_col() + 
  labs(title = "Avg 1st Round Pick Number by Team (2013-2022)",
       x = "Team",
       y = "Average 1st Round Pick Number") + 
  coord_flip() + 
  scale_fill_manual(values = c("yes" = "#E94B3CFF", "no" = "#2D2926FF")) + 
  theme_classic() + 
  theme(legend.position = "none")

plot_grid(p2, p1)
```

As college players make up around 4/5th of total drafted players, lets dive deeper into the Knicks selections
of college players over the past decade:
```{r}
draft_picks %>% 
  count(organization_type)
```

But why is it that the Knicks are drafting worse players than the other teams when they have significantly higher picks (i.e. under performing with picks)?

## Perhaps due to the colleges selected from?

## NOTE: THE BELOW SECTION RELATES TO ALL TEAMS, NOT JUST THE KNICKS AND HOW TO IMPROVE DRAFTING. BUT ESPECIALLY RELEVANT
## FOR THE KNICKS CONSIDERING THEIR POOR DRAFTING HISTORY IN THE PAST DECADE.

Firstly, it must be noted that we're only considering colleges that have had 7 or more NBA draft picks in the past decade. 
Colleges with a small number of drafted players don't have a sufficient sample size in the NBA confidently determine the
performance of that colleges players in the NBA.

**NOTE: COULD TRY TO IMPLEMENT A BETTER LOWER LIMIT SIZE OF 5 USING STATISTICS!!!**

As seen, these are the top ten colleges in terms of average college net rating of drafted players in the NBA.
If you notice anything about these colleges, they all have relatively strong reputations in the college game
for being powerhouse basketball schools, having won a total of 35 national championships between them,
out of a possible 61. Considering there's a possible 351 college teams, these ten colleges clearly are 
some of the biggest out winning 57% of all national championships in history.
```{r}
top_ten_colleges <- draft_picks %>% 
  filter(organization_type == "College") %>% 
  group_by(organization) %>% 
  mutate(n = n()) %>% 
  filter(n >= 7) %>% 
  summarise(avg_college_net_rating = mean(career_net_rating, na.rm = TRUE)) %>% 
  slice_max(order_by = avg_college_net_rating, n = 10)

top_ten_colleges
```

**VERY IMPORTANT NOTE TO MENTION**: THESE ARE SIMPLY ONE FACTOR THAT DETERMINES WINNING. THUS, IT'S HIGHLY UNLIKELY EITHER PLOTS HAVE A MASSIVE
CORRELATION WITH WINNING AND THEREFORE, A 0.10 CORRELATION AND VISIBLE DIFFERENT IN PLOTS IS IMPORTANT TO ANALYSE AND NOTICE
THE DIFFERENCE IN POTENTIALLY DRAFTING FROM POWERHOUSE COLLEGES VS INTERNATIONAL.


Clearly, no meaningful correlation between the number of selections a team makes against their win percentage. So what part
of the draft might actually influence a teams ability to win?
```{r}
team_wins_df2 <- team_wins_df %>% 
  select(team_id, team_abbreviation, total_win_percentage)

college_winning <- draft_picks %>% 
  filter(organization %in% top_ten_colleges$organization) %>% 
  group_by(team_abbreviation) %>% 
  summarise(top_ten_college_selections = n()) %>% 
  arrange(desc(top_ten_college_selections)) %>% 
  left_join(team_wins_df2) %>% 
  select(-team_id)

correlation_college <- substr(as.character(cor(college_winning$total_win_percentage, college_winning$top_ten_college_selections)), start = 0, stop = 6)

college_winning %>% 
  ggplot(aes(x = top_ten_college_selections, y = total_win_percentage)) + 
  geom_point() + 
  geom_smooth(se = FALSE) + 
  annotate(geom = "text", label = paste("correlation = ", correlation_college), color = "blue", x = 6, y = 60, size = 5) + 
  labs(title = "Effects of Drafting International Players on Winning %",
       x = "International Players Drafted (%)",
       y = "Winning Percentage") + 
  theme_classic()
```

Perhaps we could look into the effects on winning from drafting more international players?

Moderate degree of negative correlation between total_win_percentage and international drafted players. It seems as if you tend to win less
the more International players you draft.


```{r}
intenational_winning_df <- draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  count(team_abbreviation, organization_type) %>% 
  pivot_wider(names_from = organization_type, values_from = n) %>% 
  group_by(team_abbreviation) %>% 
  mutate(International = ifelse(is.na(International), 0, International)) %>%             # Accounting for LAC having drafted 0 International players.
  summarise(international_percent = International / (College + International) * 100) %>%
  left_join(team_wins_df2, on = "team_abbreviation")

correlation <- substr(as.character(cor(intenational_winning_df$total_win_percentage, intenational_winning_df$international_percent)), start = 0, stop = 6)

intenational_winning_df %>% 
  ggplot(aes(x = international_percent, y = total_win_percentage)) + 
  geom_point() + 
  geom_smooth(se = FALSE) + 
  annotate(geom = "text", label = paste("correlation = ", correlation), color = "blue", x = 23, y = 60, size = 5) + 
  labs(title = "Effects of Drafting International Players on Winning %",
       x = "International Players Drafted (%)",
       y = "Winning Percentage") + 
  theme_classic()
```

So If there is NO MEAINGFUL CORRELATION between winning percentage and the college program you draft from and there is only MODERATE
negative correlation between winning percentage and the percentage of International players you select, what is actually important?



It seems pretty obvious right? Selecting the right players with your picks.



As a further interesting note, despite drafting International players having a moderately *negative correlation* with winning percentage,
we shouldn't just not draft International players. 

* For one, it a only a moderately strong negative correlation.
* But more importantly, this data contains data on ALL INTERNATIONAL PLAYERS. Why is this of importance? International players
  as seen below are typically drafted lower than college players. Perhaps due to biases? Lack of exposure to NBA scouts? A multiple of reasons.
  

Interpretation: International players are selected on average, 4.3 picks lower than college players.

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>% 
  summarise(avg_pick_number = mean(overall_pick, na.rm = TRUE))
```


Looking further into the data, if we were to select between a College and International player, who really should we select
given selecting college players from a big program has a better correlation with winning compared to that of selecting International players?


## Are Non-College (i.e. International players) better than College players in terms of avg_net_rating?
* Compare the two and see if College or Non-College players make the bigger impact?
* Then see what demographic the knicks are primarily drafting (pie-chart). College or non-college. 
* If Non-college are making the bigger impact and Knicks are drafting more college than league avg, perhaps this is a recommendation.

As seen, draft Picks usually come from college or played professionally. Therefore, it might be worthwhile comparing the performance
of players coming from college against those coming from professional ball.
```{r}
draft_picks %>% 
  count(organization_type)
```

Interpreation: To get an overview of performance of College vs International players,
clearly the avg_rating for International players is lower than that of College players,
but the sd is higher.

This indicates that perhaps International players have a greater spread of performance, with it being more risky
to select International players due to lower average rating but it yielding potentially greater rewards
with the spread of performance being so high. It seems as if college players are the safer choice, but for more
reward, you'd select International.

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>%
  summarise(sd_rating = sd(career_net_rating, na.rm = TRUE),
            avg_rating = mean(career_net_rating, na.rm = TRUE))
```

To analyse the above further, we can look into the *quantiles*:

Interpretation: It can be seen that College the Q1 and Median college drafted played in terms for average net rating will perform
better than that of the internationally drafted player. However, the Q3 and top 10% of performing draft picks for professional players
will perform better than that of their college counterpart.  
Furthermore, it can be seen that as you increase the quantile, the international players start to increase their avg_rating relative to 
that of college players.

This suggests that drafted international players have much higher potential to be impactful players or even stars in the NBA,
which holds in line with current NBA trends as the past 4 out of 5 MVP (Most Value Player) awards have been handed to 
Giannis and Jokic, who both played internationally prior to entering the NBA.

This suggests that international players who make a difference (i.e. are in the top 25% or 10% of 
professionally drafted players) make a *larger* difference than their college counterparts can be explained by the position 
in which these players were selected.

However, on the contrary, International players who fail to make a meaningful different seem to perform worse
than their college counterparts (i.e. players in the bottom 25% or bottom 50% of net rating).

```{r}
draft_picks %>% 
  filter(organization_type %in% c("College", "International")) %>% 
  group_by(organization_type) %>% 
  summarise_at(vars(career_net_rating),
              list(Q1=~quantile(., probs = 0.25, na.rm = TRUE),
                    median=~median(.x, na.rm = TRUE), Q3=~quantile(., probs = 0.75, na.rm = TRUE),
                   top_decile = ~quantile(., probs = 0.9, na.rm = TRUE)))
```


Interpretation: As seen in the graph, the Knicks are 2nd in terms of International players drafted, with 35.3% of our draft picks being International.
Furthermore, alot of these picks have been high draft picks, as we've performed poorly in the since 2013 however, why did the Knicks still perform
poorly if we're selecting a lot of International players highly?

Simply select International players highly, but rather good recruitment is required. 

Take for example Denver, who are the 3rd highest international drafted with 31.6% of draftees coming from International basketball.
They however, won the 2022/2023 NBA championship with Nikola Jokic, their best player and one of the best players in NBA history
coming from International.

Therefore, I propose the Knicks really focus in on their drafting process and consider what qualities in International players
would help them succeed when transitioning into the NBA. 